using ClosedXML.Excel;

namespace Worksheet.Parser.ClosedXML
{
    public class ClosedXMLReader : WorksheetReader
    {
        private readonly IXLWorksheet worksheet;

        public ClosedXMLReader(IXLWorksheet worksheet) => this.worksheet = worksheet;

        public override int StartRow => 1;

        public override int StartColumn => 1;

        public override int CountColumns() => worksheet.LastColumnUsed().ColumnNumber();

        public override int CountRows() => worksheet.LastRowUsed().RowNumber();

        public override string? GetCellValue(int row, int column)
            => worksheet.Cell(row, column).GetString();

        public override void AddError(Error error)
        {
            var cell = worksheet.Cell(error.Row, error.Column);
            if (cell.HasComment)
                cell.Comment.AddNewLine().AddText(error.Message);
            else
            {
                cell.Comment.AddText(error.Message);
                FormatCellWithError(cell);
            }
        }

        private void FormatCellWithError(IXLCell cell)
        {
            cell.Style.Fill.SetBackgroundColor(XLColor.FromArgb(255, 193, 193));
            var borderColor = XLColor.Red;
            var borderType = XLBorderStyleValues.Thin;
            cell.Style.Border.LeftBorder = borderType;
            cell.Style.Border.LeftBorderColor = borderColor;
            cell.Style.Border.RightBorder = borderType;
            cell.Style.Border.RightBorderColor = borderColor;
            cell.Style.Border.TopBorder = borderType;
            cell.Style.Border.TopBorderColor = borderColor;
            cell.Style.Border.BottomBorder = borderType;
            cell.Style.Border.BottomBorderColor = borderColor;
        }
    }
}
